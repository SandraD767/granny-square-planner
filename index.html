<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Granny Square Blanket Planner</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body { font-family: Arial, sans-serif; padding: 20px; }
.controls input, .controls select { margin: 4px; }
button { margin: 6px 4px; }

#blanket {
  display: grid;
  gap: 4px;
  margin-top: 20px;
}

.square, .preview {
  position: relative;
  border: 1px solid #333;
}

.layer {
  position: absolute;
  box-sizing: border-box;
}

table {
  margin-top: 30px;
  border-collapse: collapse;
}

th, td {
  border: 1px solid #aaa;
  padding: 6px 10px;
  text-align: center;
}

.preview {
  width: 40px;
  height: 40px;
  margin: auto;
}

#yarnEstimate {
  margin-top: 20px;
}
</style>
</head>
<body>

<h1>Granny Square Blanket Planner</h1>

<div class="controls">
Width: <input type="number" id="w" value="8">
Height: <input type="number" id="h" value="10"><br>

Square size (px): <input type="number" id="size" value="60"><br>

Total colors: <input type="number" id="totalColors" value="5">
Colors per square: <input type="number" id="layers" value="3"><br>

Pattern variety:
<select id="variety">
  <option value="low">Low</option>
  <option value="medium" selected>Medium</option>
  <option value="high">High</option>
</select><br>

Seed (optional):
<input type="text" id="seed" placeholder="leave blank for random"><br>

<button onclick="buildPalette()">Set Palette</button>
<button onclick="generate()">Generate Blanket</button>
<button onclick="exportPDF()">Download PDF</button>
<button onclick="estimateYarn()">Estimate Yarn</button>
</div>

<div id="palette"></div>
<div id="blanket"></div>

<h2>Square Summary</h2>
<table>
<thead>
<tr>
<th>Preview</th>
<th>Pattern</th>
<th>Count</th>
</tr>
</thead>
<tbody id="summary"></tbody>
</table>

<div id="yarnEstimate"></div>

<script>
let palette = [];
let colorNames = [];
let lastTypes = [];
let lastCounts = [];
let lastSettings = {};
let lastGrid = [];

function seededRandom(seed) {
  let h = 2166136261 >>> 0;
  for (let i = 0; i < seed.length; i++) {
    h ^= seed.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return function() {
    h += h << 13; h ^= h >>> 7;
    h += h << 3;  h ^= h >>> 17;
    h += h << 5;
    return (h >>> 0) / 4294967296;
  };
}

function buildPalette() {
  const n = +document.getElementById("totalColors").value;
  palette = [];
  colorNames = [];
  const div = document.getElementById("palette");
  div.innerHTML = "<h3>Palette</h3>";

  for (let i = 0; i < n; i++) {
    const input = document.createElement("input");
    input.type = "color";
    input.value = "#" + Math.floor(Math.random()*16777215).toString(16).padStart(6,'0');
    palette.push(input.value);
    colorNames.push(`Color ${i+1}`);
    div.appendChild(input);
    input.oninput = () => palette[i] = input.value;
  }
}

function generate() {
  const w = +document.getElementById("w").value;
  const h = +document.getElementById("h").value;
  const size = +document.getElementById("size").value;
  const layers = +document.getElementById("layers").value;
  const variety = document.getElementById("variety").value;
  const seedInput = document.getElementById("seed").value;

  const rand = seedInput ? seededRandom(seedInput) : Math.random;
  const totalSquares = w * h;

  const divisors = { low: 10, medium: 8, high: 6 };
  const maxTypes = Math.max(5, Math.floor(totalSquares / divisors[variety]));

  const types = [];
  for (let i = 0; i < maxTypes; i++) {
    const indices = [];
    while (indices.length < layers) {
      const r = Math.floor(rand() * palette.length);
      if (!indices.includes(r)) indices.push(r);
    }
    types.push(indices);
  }

  const grid = [];
  const counts = Array(types.length).fill(0);

  for (let y = 0; y < h; y++) {
    grid[y] = [];
    for (let x = 0; x < w; x++) {
      let options = [...types.keys()];
      if (x > 0) options = options.filter(i => i !== grid[y][x-1]);
      if (y > 0) options = options.filter(i => i !== grid[y-1][x]);
      const choice = options.length
        ? options[Math.floor(rand()*options.length)]
        : Math.floor(rand()*types.length);
      grid[y][x] = choice;
      counts[choice]++;
    }
  }

  lastTypes = types;
  lastCounts = counts;
  lastSettings = { w, h, size, layers, variety };
  lastGrid = grid;

  renderBlanket(grid, types, size, layers);
  renderSummary(types, counts, layers);
  document.getElementById("yarnEstimate").innerHTML = "";
}

function renderBlanket(grid, types, size, layers) {
  const blanket = document.getElementById("blanket");
  blanket.innerHTML = "";
  blanket.style.gridTemplateColumns = `repeat(${grid[0].length}, ${size}px)`;

  grid.flat().forEach(typeIndex => {
    const sq = document.createElement("div");
    sq.className = "square";
    sq.style.width = sq.style.height = size + "px";

    types[typeIndex].forEach((colorIdx, i) => {
      const layer = document.createElement("div");
      const inset = (i / layers) * size / 2;
      layer.className = "layer";
      layer.style.background = palette[colorIdx];
      layer.style.top = layer.style.left = inset + "px";
      layer.style.width = layer.style.height = (size - inset*2) + "px";
      sq.appendChild(layer);
    });

    blanket.appendChild(sq);
  });
}

function renderSummary(types, counts, layers) {
  const tbody = document.getElementById("summary");
  tbody.innerHTML = "";

  types.forEach((type, i) => {
    if (!counts[i]) return;
    const row = document.createElement("tr");

    const preview = document.createElement("td");
    const p = document.createElement("div");
    p.className = "preview";

    type.forEach((c, j) => {
      const l = document.createElement("div");
      const inset = (j / layers) * 40 / 2;
      l.style.position = "absolute";
      l.style.background = palette[c];
      l.style.top = l.style.left = inset + "px";
      l.style.width = l.style.height = (40 - inset*2) + "px";
      p.appendChild(l);
    });

    preview.appendChild(p);

    const name = document.createElement("td");
    name.textContent = type.map(c => colorNames[c]).join(" → ");

    const count = document.createElement("td");
    count.textContent = counts[i];

    row.append(preview, name, count);
    tbody.appendChild(row);
  });
}

function exportPDF() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  let y = 10;

  pdf.text("Granny Square Blanket Plan", 10, y);
  y += 10;

  Object.entries(lastSettings).forEach(([k, v]) => {
    pdf.text(`${k}: ${v}`, 10, y);
    y += 8;
  });

  y += 5;
  lastTypes.forEach((type, i) => {
    if (!lastCounts[i]) return;
    pdf.text(
      `${type.map(c => colorNames[c]).join(" → ")} : ${lastCounts[i]} squares`,
      10,
      y
    );
    y += 7;
    if (y > 280) { pdf.addPage(); y = 10; }
  });

  pdf.save("granny-square-plan.pdf");
}

function estimateYarn() {
  if (!lastTypes.length || !lastCounts.length) {
    alert("Generate a blanket first!");
    return;
  }

  const approxAreaCm2 = 10; // rough cm² per layer per square, adjust to your yarn/square size
  const factor = 0.2; // grams per cm², rough estimate

  const yarnTotals = Array(palette.length).fill(0);

  lastTypes.forEach((type, i) => {
    type.forEach(colorIdx => {
      yarnTotals[colorIdx] += lastCounts[i] * approxAreaCm2;
    });
  });

  const container = document.getElementById("yarnEstimate");
  let html = "<h2>Estimated Yarn Usage</h2><table><tr><th>Color</th><th>Approx grams</th></tr>";
  let total = 0;
  yarnTotals.forEach((grams, idx) => {
    const est = Math.round(grams * factor);
    html += `<tr><td>${colorNames[idx]}</td><td>${est}</td></tr>`;
    total += est;
  });
  html += `<tr><td><strong>Total</strong></td><td><strong>${total}</strong></td></tr></table>`;
  container.innerHTML = html;
}
</script>

</body>
</html>
